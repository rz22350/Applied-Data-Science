import os
from PIL import Image
from tqdm import tqdm
import pandas as pd
import matplotlib.pyplot as plt

# ğŸ“‚ è®¾ç½®æ•°æ®è·¯å¾„
DATASET_PATH = "/user/home/zt22740/ads/uob_image_set/uob_image_set/"
EXPECTED_VIEWS = 5  # âœ… è®¾ç½®ä½ ç†æƒ³çš„å®Œæ•´è§†è§’æ•°é‡ï¼ˆå»ºè®®è®¾ä¸º 4 æˆ– 5ï¼‰

# ğŸ“Š ç»Ÿè®¡è®°å½•å®¹å™¨
records = []

# ğŸš€ éå†æ¯ä¸ªæœè£…æ ·æœ¬
for item_id in tqdm(os.listdir(DATASET_PATH)):
    item_path = os.path.join(DATASET_PATH, item_id)
    if not os.path.isdir(item_path):
        continue

    # è·å–æ‰€æœ‰ JPG å›¾ç‰‡è·¯å¾„
    image_paths = [os.path.join(item_path, f) for f in os.listdir(item_path) if f.lower().endswith(".jpg")]
    num_views = len(image_paths)

    # æå–ç¬¬ä¸€å¼ å›¾ç‰‡çš„å°ºå¯¸ï¼ˆå¯é€‰ï¼‰
    try:
        img = Image.open(image_paths[0])
        img_size = img.size
    except Exception:
        img_size = None

    # âœ… ä¿®æ­£ missing_views è®¡ç®—
    record = {
        "item_id": item_id,
        "num_views": num_views,
        "image_size": img_size,
        "missing_views": max(0, EXPECTED_VIEWS - num_views),
        "extra_views": max(0, num_views - EXPECTED_VIEWS)
    }

    records.append(record)

# ğŸ“‹ ç”Ÿæˆ DataFrame
df = pd.DataFrame(records)

# ğŸ’¾ ä¿å­˜ç»“æœåˆ° CSV
df.to_csv("fashion_view_stats.csv", index=False)
print("âœ… ä¿å­˜ç»Ÿè®¡ç»“æœåˆ° fashion_view_stats.csv")

# ğŸ“ˆ æ‰“å°ç»Ÿè®¡æ‘˜è¦
print("\nğŸ“Š ç»Ÿè®¡æ‘˜è¦ï¼š")
print(df[["num_views", "missing_views", "extra_views"]].describe())

# ğŸ” æŸ¥çœ‹ missing_views çš„åˆ†å¸ƒæƒ…å†µ
print("\nğŸ“Š missing_views åˆ†å¸ƒï¼ˆæ£€æŸ¥æ˜¯å¦åˆç†ï¼‰ï¼š")
print(df["missing_views"].value_counts().sort_index())

# ğŸ“Š å¯è§†åŒ–å›¾åƒæ•°åˆ†å¸ƒ
plt.figure(figsize=(8, 5))
df["num_views"].hist(bins=range(df["num_views"].min(), df["num_views"].max() + 2), color="skyblue", edgecolor="black")
plt.title("åˆ†è§†è§’å›¾åƒæ•°é‡åˆ†å¸ƒ")
plt.xlabel("è§†è§’å›¾åƒæ•°é‡")
plt.ylabel("æ ·æœ¬æ•°é‡")
plt.grid(True)
plt.tight_layout()
plt.savefig("view_count_histogram.png")
plt.show()
print("âœ… å·²ç”Ÿæˆè§†è§’æ•°é‡åˆ†å¸ƒå›¾ view_count_histogram.png")
